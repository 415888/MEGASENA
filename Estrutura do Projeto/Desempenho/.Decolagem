%% ========================================================================
%      FLIGHT PERFORMANCE – TAKEOFF, CLIMB, WIND, TURBOPROP, ROC MAP
%                  FULL MATLAB SCRIPT FOR GRAPHICS
% ========================================================================

clc; clear; close all;
fprintf("\n=== ADVANCED FLIGHT PERFORMANCE MODEL ===\n\n");

%% ========================================================================
%%                         USER INPUTS
%% ========================================================================

MTOW = input('MTOW [kg]: ');
W_ref = input('Peso inicial de referência [kg]: ');
S = input('Área da asa S [m²]: ');
c_mac = input('Corda média (MAC) [m]: ');
CD0 = input('CD0: ');
k = input('k (fator de arrasto induzido): ');
CLmax_TO = input('CLmax de decolagem: ');
CLmax_clean = input('CLmax limpo: ');
n_eng = input('Número de motores: ');

%% Turboprop
T0_SL = input('Tração total ao nível do mar (N): ');
alpha_T = input('Expoente de densidade para turboprop (ex: 1.0): ');
beta_speed = input('Coef. redução com velocidade (ex: 0.02): ');
Vref_T = input('Velocidade de referência para empuxo (ex: 200 m/s): ');

%% Atmosfera e análise
alt_vec = input('Altitudes de análise (ex: [0 1000 2000 4000]): ');
wind_vec = input('Headwind/Tailwind [m/s], positivo=headwind (ex: [0 5 10 -5]): ');

Vmin = input('Velocidade mínima [m/s]: ');
Vmax = input('Velocidade máxima [m/s]: ');
NV = 400;
V = linspace(Vmin, Vmax, NV);

h_obst = input('Altura do obstáculo (m): ');
nW = input('Número de pesos até MTOW: ');

%% ========================================================================
%%                   CONSTANTES E MICROFUNÇÕES
%% ========================================================================
g = 9.81;
rho0 = 1.225;
T0 = 288.15;
p0 = 101325;
R = 287;

%% Atmosfera ISA
isa = @(h) isa_calc(h);

%% Sutherland (viscosidade)
mu_suth = @(T) 1.716e-5 * (T/273.15)^(3/2) * (273.15+110.4)/(T+110.4);

%% ========================================================================
%%                   MATRIZES DE RESULTADOS
%% ========================================================================
W_vec = linspace(W_ref*g, MTOW*g, nW);

ROC_map = zeros(length(alt_vec), length(W_vec));
Vroc_map = zeros(size(ROC_map));
Takeoff_map = zeros(size(ROC_map));

%% ========================================================================
%%                 LOOP PRINCIPAL: ALTITUDE × PESO
%% ========================================================================

for ia = 1:length(alt_vec)
    alt = alt_vec(ia);
    A = isa(alt);
    rho = A.rho;

    for iw = 1:length(W_vec)
        W = W_vec(iw);
        m = W/g;

        %% ------------------ AERODINÂMICA ------------------
        q = 0.5*rho*V.^2;
        CL_req = W ./ (q*S);
        CD = CD0 + k .* CL_req.^2;
        D = CD.*q.*S;

        %% ------------------ TURBOPROP ------------------
        T = T0_SL*(rho/rho0)^alpha_T .* (1 - beta_speed*(V./Vref_T));
        T(T<0)=0;

        %% ------------------ POTÊNCIA E ROC ------------------
        P_req = D.*V;
        P_av = T.*V;
        ROC = (P_av - P_req)./W;
        ROC(ROC<0)=0;

        [ROC_peak, idx] = max(ROC);
        ROC_map(ia, iw) = ROC_peak;
        Vroc_map(ia, iw) = V(idx);

        %% ------------------ DECOLAGEM ------------------
        CL_TO = 0.9*CLmax_TO;
        Vstall_TO = sqrt(2*W/(rho*S*CLmax_TO));
        Vrot = 1.2*Vstall_TO;
        V_to = linspace(0, Vrot, 300);

        q_to = 0.5*rho*V_to.^2;
        CD_to = CD0 + k*CL_TO^2;
        D_to = CD_to.*q_to.*S;
        L_to = CL_TO.*q_to.*S;

        T_to = T0_SL*(rho/rho0)^alpha_T .* (1 - beta_speed*(V_to./Vref_T));

        mu_r = 0.03;
        a_to = (T_to - D_to - mu_r*(W-L_to))/m;
        a_to(a_to<0.1)=0.1;

        dx = cumtrapz(V_to./a_to);
        ground_run = dx(end);

        ROC_vrot = interp1(V, ROC, Vrot, "linear", 0);
        if ROC_vrot<=0
            climb_dist = Inf;
        else
            climb_dist = Vrot*(h_obst/ROC_vrot);
        end

        Takeoff_map(ia, iw) = ground_run + climb_dist;

    end
end

%% ========================================================================
%%                    GRÁFICO 1 — MAPA ROC(ALT, PESO)
%% ========================================================================
figure; surf(W_vec/g, alt_vec, ROC_map, 'EdgeColor','none');
xlabel("Peso [kg]"); ylabel("Altitude [m]"); zlabel("ROC [m/s]");
title("Mapa ROC (Altitude × Peso)"); colorbar; view(40,30);

%% ========================================================================
%%                    GRÁFICO 2 — CONTORNO ROC
%% ========================================================================
figure; contourf(W_vec/g, alt_vec, ROC_map, 20, 'LineColor','none');
xlabel("Peso [kg]"); ylabel("Altitude [m]");
title("Contorno ROC (m/s)"); colorbar;

%% ========================================================================
%%          GRÁFICO 3 — ROC vs velocidade (para pesos principais)
%% ========================================================================
figure; hold on; grid on;
for iw = 1:length(W_vec)
    W = W_vec(iw);
    A = isa(alt_vec(1));
    rho = A.rho;

    q = 0.5*rho*V.^2;
    CL_req = W./(q*S);
    CD = CD0 + k.*CL_req.^2;
    D = CD.*q.*S;
    T = T0_SL*(rho/rho0)^alpha_T .* (1 - beta_speed*(V./Vref_T));
    ROC = (T.*V - D.*V)./W;
    ROC(ROC<0)=0;

    plot(V, ROC, "LineWidth",1.6, ...
        "DisplayName",sprintf("W = %.0f kg", W/g));
end
xlabel("Velocidade [m/s]"); ylabel("ROC [m/s]");
title("Razão de Subida vs Velocidade"); legend;

%% ========================================================================
%%           GRÁFICO 4 — Efeito do vento na decolagem
%% ========================================================================
alt0 = alt_vec(1);
A0 = isa(alt0);
rho0 = A0.rho;

Wex = max(W_vec);
Vstall_TO = sqrt(2*Wex/(rho0*S*CLmax_TO));
Vrot = 1.2*Vstall_TO;
Dist_vs_wind = zeros(size(wind_vec));

for ih = 1:length(wind_vec)
    hw = wind_vec(ih);

    V_to = linspace(0, Vrot, 300);
    Vground = max(V_to - hw, 0.1);

    q_to = 0.5*rho0*V_to.^2;
    CD_to = CD0 + k*(0.9*CLmax_TO)^2;
    D_to = CD_to.*q_to.*S;
    L_to = 0.9*CLmax_TO.*q_to.*S;

    T_to = T0_SL*(rho0/rho0)^alpha_T .* (1 - beta_speed*(V_to./Vref_T));
    a_to = (T_to - D_to - 0.03*(Wex - L_to)) / (Wex/g);
    a_to(a_to<0.1)=0.1;

    dx = cumtrapz(Vground./a_to);
    ground = dx(end);

    % ROC to obstacle
    q = 0.5*rho0*V.^2;
    CLr = Wex./(q*S);
    CDr = CD0 + k.*CLr.^2;
    Dr = CDr.*q*S;
    Tr = T0_SL*(rho0/rho0)^alpha_T .* (1 - beta_speed*(V./Vref_T));
    ROC = (Tr.*V - Dr.*V)./Wex; ROC(ROC<0)=0;

    ROC_vrot = interp1(V, ROC, Vrot, "linear", 0);
    climb = Vrot*(h_obst/ROC_vrot);

    Dist_vs_wind(ih) = ground + climb;
end

figure; plot(wind_vec, Dist_vs_wind, "-o","LineWidth",2);
xlabel("Vento de proa (+) / cauda (-) [m/s]");
ylabel("Distância de decolagem [m]");
title("Efeito do vento na distância de decolagem");
grid on;

%% ========================================================================
%%          GRÁFICO 5 — Polar completa CD(CL)
%% ========================================================================
CL_list = linspace(0, CLmax_clean, 200);
CD_list = CD0 + k.*CL_list.^2;

figure;
plot(CL_list, CD_list, 'LineWidth',2);
xlabel("CL"); ylabel("CD");
title("Polar aerodinâmica CL–CD (limpo)");
grid on;


end
